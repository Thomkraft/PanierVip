{% extends 'base.html.twig' %}

{% block title %}ShoppingList index{% endblock %}

{% block body %}
    <h1>Your shopping lists</h1>

    {% set total_price_all_lists = 0 %}
    {% set total_items = 0 %}
    {% set total_cost = 0 %}

    {% set highest_item = null %}
    {% set lowest_item = null %}
    {% set highest_price = 0 %}
    {% set lowest_price = null %}

    {% set category_expenses = {} %}

    {% for shopping_list in shopping_lists %}
        {% if shopping_list.utilisateur.id == user.id %}
            {% for listed_product in shopping_list.listedProducts %}
                {% set item_price = (listed_product.product.euros * 100 + listed_product.product.centimes) * listed_product.quantity %}
                {% set total_price_all_lists = total_price_all_lists + item_price %}
                {% set total_items = total_items + listed_product.quantity %}
                {% set total_cost = total_cost + item_price %}

                {% set item_unit_price = (listed_product.product.euros * 100 + listed_product.product.centimes) %}

                {% if highest_item is null or item_unit_price > highest_price %}
                    {% set highest_item = listed_product.product %}
                    {% set highest_price = item_unit_price %}
                {% endif %}

                {% if lowest_item is null or item_unit_price < lowest_price %}
                    {% set lowest_item = listed_product.product %}
                    {% set lowest_price = item_unit_price %}
                {% endif %}


                {% set category_name = listed_product.product.category.name %}
                {% set item_total_price = (listed_product.product.euros * 100 + listed_product.product.centimes) * listed_product.quantity %}

                {% if category_expenses[category_name] is not defined %}
                    {% set category_expenses = category_expenses|merge({ (category_name): item_total_price }) %}
                {% else %}
                    {% set category_expenses = category_expenses|merge({ (category_name): category_expenses[category_name] + item_total_price }) %}
                {% endif %}

            {% endfor %}
        {% endif %}
    {% endfor %}

    {% set average_price_per_item = total_items > 0 ? (total_cost // total_items) / 100 : 0 %}

    <div class="d-flex flex-row p-3 gap-5 align-items-top">
        <div class="card d-flex flex-column justify-content-between p-3 h-100 bg-success-subtle border border-black border-opacity-10 shadow position-relative" style="max-width: 18rem;">
            <div class="card-header">Total Cost</div>
            <div class="card-body">
                <h5 class="card-title">Total Price of all Lists</h5>
                <p class="card-text"><strong>{{ (total_price_all_lists // 100) }}€{{ total_price_all_lists % 100 }}</strong></p>
            </div>
        </div>

        <div class="card d-flex flex-column justify-content-between p-3 h-100 bg-success-subtle border border-black border-opacity-10 shadow position-relative" style="max-width: 18rem;">
            <div class="card-header">Average Cost</div>
            <div class="card-body">
                <h5 class="card-title">Average Cost per Item</h5>
                <p class="card-text"><strong>{{ average_price_per_item }}€</strong></p>
            </div>
        </div>

        <div class="card d-flex flex-column justify-content-between p-3 h-100 bg-success-subtle border border-black border-opacity-10 shadow position-relative" style="max-width: 18rem;">
            <div class="card-header">Highest and lowest product</div>
            <div class="card-body">
                <h5 class="card-title">Highest Product</h5>
                <p class="card-text"><strong>{{ highest_item.name }} : {{ highest_price // 100 }}€{{ highest_price % 100 }}</strong></p>

                <h5 class="card-title">Lowest Product</h5>
                <p class="card-text"><strong>{{ lowest_item.name }} : {{ lowest_price // 100 }}€{{ lowest_price % 100 }}</strong></p>
            </div>
        </div>

        <div class="card d-flex flex-column justify-content-between p-3 h-100 bg-success-subtle border border-black border-opacity-10 shadow position-relative" style="max-width: 18rem;">
            <div class="card-header">Distribution of expenses</div>
            <div class="card-body">
                <h5 class="card-title">Expenses by Category</h5>
                {% if category_expenses is not empty %}
                    <ul class="lh-base">
                        {% for category, amount in category_expenses %}
                            <li><strong>{{ category }}</strong> : {{ (amount // 100) }}€{{ amount % 100 }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="card-text">No purchases recorded</p>
                {% endif %}
            </div>
        </div>
    </div>


    <div id="shopping-list-table" class="container row mx-auto my-3">

        {% for shopping_list in shopping_lists %}

            {% if shopping_list.utilisateur.id == user.id %}
                <div class="col-lg-4 col-md-6 col-12 p-3">
                    <div class="shopping-list-container">

                        <img
                                src="{{ asset('images/thumbtack-' ~ random(1, 3) ~ '.png') }}" alt="Thumbtack Image"
                                class="sl-thumbtack"
                        >

                        <div class="lh-sm">
                            <p><strong>Name :</strong> {{ shopping_list.name }}</p>
                            <p><strong>Number of products:</strong> {{ shopping_list.nbProducts }}</p>
                            <p><strong>Products:</strong></p>

                            <ul class="lh-base">
                                {% for listed_product in shopping_list.listedProducts %}

                                    {% if loop.index0 <= 2 %}

                                        <li style="{% if listed_product.bought %}text-decoration: line-through;{% endif %}"
                                        ><strong>{{ listed_product.product.name }}</strong> x
                                             {{ listed_product.quantity }} :
                                            {{ listed_product.product.weight * listed_product.quantity}}g ,
                                            {{ _self.total_price(listed_product.product, listed_product.quantity) }}
                                        </li>

                                    {% else %}

                                        {% if loop.last %}
                                            <li> ... </li>
                                        {% endif %}
                                    {% endif %}

                                {% endfor %}
                            </ul>
                        </div>

                        <div class="d-flex justify-content-end gap-2 align-items-center">
                            <a href="{{ path('app_shopping_list_show', {'id': shopping_list.id}) }}">Show</a>
                            <a href="{{ path('app_shopping_list_edit', {'id': shopping_list.id}) }}" class="">Edit</a>

                            {{ include('shopping_list/_delete_form.html.twig', { 'shopping_list': shopping_list }) }}
                        </div>

                    </div>
                </div>
            {% endif %}

        {% else %}

            <p>No records found</p>

        {% endfor %}
    </div>

    <a id="plus-button" class="position-fixed bg-warning rounded-circle p-1" href="{{ path('app_shopping_list_new') }}">
        <svg width="50px" height="50px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 12H18M12 6V18" stroke="#f7f7f9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            New list
        </svg>
    </a>


    {% if is_granted('ROLE_ADMIN') %}
        <a id="admin-button" class="position-fixed bg-danger rounded-circle border-1" href="{{ path('app_admin') }}">
            <svg fill="#000000" width="35px" height="35px" viewBox="-1 0 19 19" xmlns="http://www.w3.org/2000/svg" class="cf-icon-svg"><path d="M16.014 8.86v1.44a.587.587 0 0 1-.468.556l-1.182.204a.463.463 0 0 1-.114.006 5.902 5.902 0 0 1-.634 1.528.455.455 0 0 1 .078.084l.691.98a.586.586 0 0 1-.062.725l-1.02 1.02a.586.586 0 0 1-.724.061l-.98-.69a.444.444 0 0 1-.085-.078 5.908 5.908 0 0 1-1.544.637.502.502 0 0 1 0 .175l-.182 1.053a.667.667 0 0 1-.633.532h-1.31a.667.667 0 0 1-.633-.532l-.182-1.053a.495.495 0 0 1 0-.175 5.908 5.908 0 0 1-1.544-.637.444.444 0 0 1-.085.077l-.98.691a.586.586 0 0 1-.725-.062l-1.02-1.02a.586.586 0 0 1-.061-.723l.691-.98a.454.454 0 0 1 .077-.085 5.901 5.901 0 0 1-.633-1.528.466.466 0 0 1-.114-.006l-1.182-.204a.586.586 0 0 1-.468-.556V8.86a.586.586 0 0 1 .468-.556L2.636 8.1a.437.437 0 0 1 .114-.005 5.912 5.912 0 0 1 .633-1.528.466.466 0 0 1-.077-.085l-.691-.98a.587.587 0 0 1 .061-.724l1.02-1.02a.587.587 0 0 1 .725-.062l.98.691a.444.444 0 0 1 .085.078 5.903 5.903 0 0 1 1.528-.634.433.433 0 0 1 .005-.114l.204-1.182a.586.586 0 0 1 .556-.468h1.442a.586.586 0 0 1 .556.468l.204 1.182a.448.448 0 0 1 .005.114 5.908 5.908 0 0 1 1.528.634.444.444 0 0 1 .085-.078l.98-.691a.586.586 0 0 1 .724.062l1.02 1.02a.586.586 0 0 1 .062.724l-.691.98a.467.467 0 0 1-.078.085 5.902 5.902 0 0 1 .634 1.528.434.434 0 0 1 .114.005l1.182.204a.587.587 0 0 1 .468.556zm-4.955.72a2.559 2.559 0 1 0-2.56 2.56 2.559 2.559 0 0 0 2.56-2.56z"/>
                Admin
            </svg>
        </a>
    {% endif %}

{% endblock %}

{% macro total_price(product, quantity) %}
    {% set total_centimes = (product.euros * 100 + product.centimes) * quantity %}
    {% set total_euros = (total_centimes // 100) %}
    {% set remaining_centimes = (total_centimes % 100) %}
    {%if remaining_centimes == 0 %}
    {% set remaining_centimes = '' %}
    {% endif %}
    {{ total_euros }}€{{ remaining_centimes }}
{% endmacro %}
