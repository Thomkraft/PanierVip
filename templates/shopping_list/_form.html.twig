{# Store listed product prototype fields #}
{% set prototype_product = form_widget(form.listedProducts.vars.prototype.product) %}
{% set prototype_quantity = form_widget(form.listedProducts.vars.prototype.quantity) %}
{% set prototype_bought = form_widget(form.listedProducts.vars.prototype.bought) %}

{{ form_start(form) }}

<div class="mb-3">
    <h5>Add new product</h5>

    <div id="new-listed-products-container">

        {{ form_row(form.name) }}

        {% for listedProduct in form.listedProducts %}
            <div class="d-flex flex-row align-items-center gap-2 listed-product-form">

                {{ form_row(listedProduct.product) }}
                {{ form_row(listedProduct.quantity) }}

                {% if (app.request.pathinfo == '/shopping/list/new') != 1 %}
                    {{ form_row(listedProduct.bought) }}
                {% endif %}
                <button type="button" class="btn btn-danger remove-listed-product">X</button>
            </div>

        {% else %}
            <p>No added products</p>
        {% endfor %}

        <div class="text-danger">
            {{ form_errors(form) }}
        </div>

    </div>

    <button type="button" class="btn btn-primary my-3" id="add-listed-product">Add new product</button>

</div>

<button class="btn btn-success" type="submit">{{ button_label|default('Save') }}</button>

{{ form_end(form) }}

{% block javascripts %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let listedProductsContainer = document.getElementById("new-listed-products-container");
            let addButton = document.getElementById("add-listed-product");

            let index = {{ form.listedProducts|length }};

            let prototypeTemplate = `
                <div class="d-flex flex-row align-items-center listed-product-form">
                    <div class="me-2">{{ prototype_product|e('js') }}</div>
                    <div class="me-2">{{ prototype_quantity|e('js') }}</div>

                    {% if (app.request.pathinfo != '/shopping-list/new') != 1 %}
                        <div class="me-2">{{ prototype_bought|e('js') }}</div>
                    {% endif %}

                    <button type="button" class="btn btn-danger remove-listed-product">X</button>
                </div>`;

            function updateProductOptions() {
                let selectedProducts = Array.from(document.querySelectorAll(".listed-product-form select"))
                    .map(select => select.value)
                    .filter(value => value !== "");

                document.querySelectorAll(".listed-product-form select").forEach(select => {
                    select.querySelectorAll("option").forEach(option => {
                        if (selectedProducts.includes(option.value) && option.value !== select.value) {
                            option.hidden = true;
                        } else {
                            option.hidden = false;
                        }
                    });
                });
            }

            addButton.addEventListener("click", function () {
                let newProductForm = prototypeTemplate.replace(/__name__/g, index);
                let newProduct = document.createElement("div");
                newProduct.innerHTML = newProductForm;
                listedProductsContainer.appendChild(newProduct);
                index++;

                updateProductOptions();
            });

            listedProductsContainer.addEventListener("click", function (event) {
                if (event.target.classList.contains("remove-listed-product")) {
                    event.target.closest(".listed-product-form").remove();
                    updateProductOptions();
                }
            });

            listedProductsContainer.addEventListener("change", function (event) {
                if (event.target.tagName === "SELECT") {
                    updateProductOptions();
                }
            });

            updateProductOptions();
        });


    </script>
{% endblock %}
